<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Election Voting System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #4a90e2; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; font-size: 1.8rem; }
        .section { display: none; }
        .section.active { display: block; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 14px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 1rem; }
        .form-group input:focus { border-color: #4a90e2; outline: none; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #4a90e2; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-admin { background: #9b59b6; color: white; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        .position-card { border: 1px solid #e0e6ed; border-radius: 10px; padding: 16px; margin-bottom: 16px; background: #fafbfc; }
        .position-card h3 { color: #2c3e50; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .candidate-option { display: flex; align-items: center; padding: 10px; margin: 6px 0; background: white; border-radius: 8px; cursor: pointer; }
        .candidate-option:hover { background: #f0f4f8; }
        .candidate-option input { margin-right: 12px; }
        .candidate-info { flex: 1; }
        .candidate-name { font-weight: 600; color: #2c3e50; }
        .candidate-bio { font-size: 0.9rem; color: #7f8c8d; margin-top: 4px; }
        .alert { padding: 12px; border-radius: 8px; margin: 10px 0; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        #loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e0e6ed; border-top-color: #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%; }
        .modal-content h4 { margin-bottom: 16px; }
        .modal-content input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e0e6ed; border-radius: 6px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }
        #voting-admin-panel { display: none; margin: 15px 0; padding: 12px; background: #f8f4ff; border: 1px solid #d4b8f0; border-radius: 8px; }
        #voting-admin-panel.active { display: block; }
        .position-field { background: #f8f9fa; border: 1px solid #e0e6ed; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .candidates-list { margin-top: 12px; }
        .candidate-field { background: white; border: 1px solid #e0e6ed; border-radius: 6px; padding: 12px; margin: 8px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è NGO Election Voting System</h1>
            <p>Secure ‚Ä¢ Anonymous ‚Ä¢ Real-time Results</p>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="section card">
            <h2>üõ†Ô∏è Election Setup</h2>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Existing candidates loaded from database. You can modify and re-save.
            </div>
            <p style="margin: 12px 0;">Configure positions and candidates. Once saved, voting begins.</p>
            
            <div class="form-group">
                <label>üîê Setup Password <small>(Default: admin123)</small></label>
                <input type="password" id="setup-password" placeholder="Enter admin password">
            </div>
            
            <div id="positions-container"></div>
            
            <button type="button" onclick="addPositionField()" class="btn btn-secondary" style="margin: 10px 0;">‚ûï Add New Position</button>
            
            <div class="btn-group">
                <button type="button" onclick="saveElectionConfig()" class="btn btn-primary">üöÄ Start Election</button>
                <button type="button" onclick="clearSetupForm()" class="btn btn-secondary">üîÑ Reset Form</button>
            </div>
        </div>

        <!-- Voting Section -->
        <div id="voting-section" class="section card">
            <h2>üó≥Ô∏è NGO Annual Election</h2>
            <p style="margin: 10px 0;">Select your candidate for each position. Results appear immediately after voting.</p>
            
            <div class="alert alert-info" style="font-size: 0.9rem;">
                üìã Election ID: <span id="election-id-display">-</span> | Started: <span id="election-start-display">-</span>
            </div>
            
            <!-- Admin Edit Panel -->
            <div id="voting-admin-panel">
                <button type="button" onclick="openEditFromVoting()" class="btn btn-admin">‚úèÔ∏è Edit Candidates/Positions (Admin)</button>
            </div>
            
            <div id="voting-positions-container"></div>
            
            <button type="button" onclick="submitVote()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">‚úÖ Submit My Vote</button>
            
            <div class="alert alert-warning" style="margin-top: 16px;">
                üîí Your vote is anonymous. Each position can only be voted once per device.
            </div>
            
            <div id="admin-only-section" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 2px dashed #e0e6ed;">
                <h4 style="color: #9b59b6; margin-bottom: 10px;">‚ö†Ô∏è Admin Only</h4>
                <button type="button" onclick="openResetModal()" class="btn btn-danger">üîÑ Reset Election (Back to Setup)</button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="section">
            <div class="spinner"></div>
            <p>Loading Election System...</p>
            <p id="loading-status" style="color: #7f8c8d;">Connecting to database</p>
        </div>

        <!-- Reset Modal -->
        <div id="reset-modal" class="modal">
            <div class="modal-content">
                <h4>‚ö†Ô∏è Reset Election?</h4>
                <p style="margin: 12px 0;">This will DELETE ALL votes and candidates, and return to Setup page.</p>
                <p style="color: #e74c3c; font-weight: 600; margin: 8px 0;">‚ö†Ô∏è This action CANNOT be undone!</p>
                <input type="password" id="reset-password-input" placeholder="Enter Admin Password to Confirm:">
                <div class="modal-buttons">
                    <button type="button" onclick="closeResetModal()" class="btn btn-secondary">Cancel</button>
                    <button type="button" onclick="confirmResetElection()" class="btn btn-danger">üóëÔ∏è Yes, Reset Everything</button>
                </div>
            </div>
        </div>

        <!-- Admin Auth Modal -->
        <div id="admin-auth-modal" class="modal">
            <div class="modal-content">
                <h4>üîê Admin Verification</h4>
                <p style="margin: 12px 0;">Enter password to edit candidates/positions:</p>
                <input type="password" id="admin-password-input" placeholder="Admin password">
                <div class="modal-buttons">
                    <button type="button" onclick="closeAdminModal()" class="btn btn-secondary">Cancel</button>
                    <button type="button" onclick="verifyAdminAndEdit()" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global State
        let currentElectionId = null;
        let userVotes = {};
        let isAdmin = false;
        let isEditingFromVoting = false;
        let votingStateBeforeEdit = null;
        
        // Admin Check
        function checkAdminAccess() {
            const saved = sessionStorage.getItem('isAdmin');
            if (saved === 'true') {
                isAdmin = true;
                document.getElementById('voting-admin-panel').classList.add('active');
                document.getElementById('admin-only-section').style.display = 'block';
            }
        }
        
        // Open Edit from Voting
        function openEditFromVoting() {
            if (isAdmin) {
                votingStateBeforeEdit = {};
                document.querySelectorAll('#voting-section input[type="radio"]:checked').forEach(radio => {
                    const pos = radio.name.replace('position_', '');
                    votingStateBeforeEdit[pos] = radio.value;
                });
                isEditingFromVoting = true;
                showSection('setup-section');
                loadElectionConfigForEdit();
            } else {
                document.getElementById('admin-auth-modal').classList.add('active');
            }
        }
        
        function closeAdminModal() {
            document.getElementById('admin-auth-modal').classList.remove('active');
            document.getElementById('admin-password-input').value = '';
        }
        
        async function verifyAdminAndEdit() {
            const password = document.getElementById('admin-password-input').value;
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                if (password === adminPwd) {
                    sessionStorage.setItem('isAdmin', 'true');
                    isAdmin = true;
                    closeAdminModal();
                    document.getElementById('voting-admin-panel').classList.add('active');
                    document.getElementById('admin-only-section').style.display = 'block';
                    votingStateBeforeEdit = {};
                    document.querySelectorAll('#voting-section input[type="radio"]:checked').forEach(radio => {
                        const pos = radio.name.replace('position_', '');
                        votingStateBeforeEdit[pos] = radio.value;
                    });
                    isEditingFromVoting = true;
                    showSection('setup-section');
                    loadElectionConfigForEdit();
                } else {
                    alert('‚ùå Incorrect password');
                }
            } catch (error) {
                alert('‚ö†Ô∏è Verification failed');
            }
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }
        
        function addPositionField(positionData = null) {
            const container = document.getElementById('positions-container');
            const posId = positionData?.id || 'pos_' + Date.now();
            const div = document.createElement('div');
            div.className = 'position-field';
            div.dataset.positionId = posId;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>Position #${container.children.length + 1}</strong>
                    <button type="button" onclick="this.closest('.position-field').remove()" class="btn btn-danger" style="padding:6px 12px;">üóëÔ∏è Remove</button>
                </div>
                <div class="form-group">
                    <label>Position Name</label>
                    <input type="text" class="position-name" value="${positionData?.name || ''}" placeholder="e.g., President">
                </div>
                <div class="form-group">
                    <label>Description (optional)</label>
                    <textarea class="position-desc" rows="2">${positionData?.description || ''}</textarea>
                </div>
                <div class="candidates-list" id="candidates-${posId}">
                    ${positionData?.candidates?.map(c => `
                        <div class="candidate-field" data-candidate-id="${c.id}">
                            <input type="text" class="candidate-name" value="${c.name || ''}" placeholder="Candidate name" style="width:100%; margin-bottom:8px;">
                            <textarea class="candidate-bio" placeholder="Bio" style="width:100%; margin-bottom:8px;">${c.bio || ''}</textarea>
                            <input type="hidden" class="candidate-id" value="${c.id}">
                            <input type="hidden" class="candidate-votes" value="${c.votes || 0}">
                            <input type="hidden" class="candidate-electionId" value="${c.electionId || ''}">
                            <button type="button" onclick="this.closest('.candidate-field').remove()" style="background:#e74c3c;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;">Remove</button>
                        </div>
                    `).join('') || ''}
                </div>
                <button type="button" onclick="addCandidateField('${posId}')" class="btn btn-secondary" style="margin:8px 0;">‚ûï Add Candidate</button>
                <hr style="margin:20px 0;">
            `;
            container.appendChild(div);
        }
        
        function addCandidateField(positionId) {
            const container = document.getElementById(`candidates-${positionId}`);
            const div = document.createElement('div');
            div.className = 'candidate-field';
            div.innerHTML = `
                <input type="text" class="candidate-name" placeholder="Candidate name" style="width:100%; margin-bottom:8px;">
                <textarea class="candidate-bio" placeholder="Bio" style="width:100%; margin-bottom:8px;"></textarea>
                <input type="hidden" class="candidate-id" value="cand_${Date.now()}">
                <input type="hidden" class="candidate-votes" value="0">
                <input type="hidden" class="candidate-electionId" value="">
                <button type="button" onclick="this.closest('.candidate-field').remove()" style="background:#e74c3c;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;">Remove</button>
            `;
            container.appendChild(div);
        }
        
        function clearSetupForm() {
            if (confirm('Clear all form data?')) {
                document.getElementById('positions-container').innerHTML = '';
                document.getElementById('setup-password').value = '';
            }
        }
        
        // Safe Update - Preserve Votes
        async function safeUpdateCandidate(candidateId, updates) {
            const ref = db.collection('candidates').doc(candidateId);
            const snap = await ref.get();
            if (!snap.exists) return;
            const current = snap.data();
            await ref.update({
                name: updates.name !== undefined ? updates.name : current.name,
                bio: updates.bio !== undefined ? updates.bio : current.bio,
                lastModified: new Date()
            });
        }
        
        async function saveElectionConfig() {
            const password = document.getElementById('setup-password').value;
            if (!password) { alert('‚ö†Ô∏è Please enter admin password'); return; }
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                if (password !== adminPwd) { alert('‚ùå Incorrect password'); return; }
                
                const positions = [];
                document.querySelectorAll('.position-field').forEach(posEl => {
                    const posId = posEl.dataset.positionId;
                    const candidates = [];
                    posEl.querySelectorAll('.candidate-field').forEach(candEl => {
                        const name = candEl.querySelector('.candidate-name').value.trim();
                        if (!name) return;
                        candidates.push({
                            id: candEl.querySelector('.candidate-id').value,
                            name: name,
                            bio: candEl.querySelector('.candidate-bio').value.trim(),
                            votes: parseInt(candEl.querySelector('.candidate-votes').value) || 0,
                            electionId: candEl.querySelector('.candidate-electionId').value || ''
                        });
                    });
                    if (candidates.length > 0) {
                        positions.push({
                            id: posId,
                            name: posEl.querySelector('.position-name').value.trim(),
                            description: posEl.querySelector('.position-desc').value.trim(),
                            candidates: candidates
                        });
                    }
                });
                
                if (positions.length === 0) { alert('‚ö†Ô∏è Add at least one position'); return; }
                
                const electionId = currentElectionId || 'election_' + Date.now();
                currentElectionId = electionId;
                
                const batch = db.batch();
                positions.forEach(pos => {
                    const posRef = db.collection('positions').doc(pos.id);
                    if (isEditingFromVoting) {
                        batch.update(posRef, { name: pos.name, description: pos.description, lastModified: new Date() });
                    } else {
                        batch.set(posRef, { id: pos.id, name: pos.name, description: pos.description, electionId: electionId, createdAt: new Date(), totalVotes: 0 });
                    }
                    pos.candidates.forEach(cand => {
                        const candRef = db.collection('candidates').doc(cand.id);
                        if (isEditingFromVoting && cand.electionId) {
                            batch.update(candRef, { name: cand.name, bio: cand.bio, lastModified: new Date() });
                        } else {
                            batch.set(candRef, { ...cand, positionId: pos.id, electionId: electionId, photo: '' });
                        }
                    });
                });
                
                if (!isEditingFromVoting) {
                    const configRef = db.collection('system').doc('config');
                    batch.set(configRef, { currentElectionId: electionId, electionStatus: 'active', startedAt: new Date(), adminPassword: password }, { merge: true });
                }
                
                await batch.commit();
                alert('‚úÖ Election configured successfully!');
                
                if (isEditingFromVoting) {
                    returnToVotingAfterEdit();
                } else {
                    showSection('voting-section');
                    loadVotingInterface();
                }
            } catch (error) {
                alert('‚ö†Ô∏è Failed to save: ' + error.message);
            }
        }
        
        async function loadVotingInterface() {
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const electionId = configSnap.data()?.currentElectionId;
                if (!electionId) { showSection('setup-section'); return; }
                
                currentElectionId = electionId;
                document.getElementById('election-id-display').textContent = electionId;
                const startedAt = configSnap.data()?.startedAt;
                if (startedAt) {
                    document.getElementById('election-start-display').textContent = new Date(startedAt.seconds * 1000).toLocaleDateString();
                }
                
                const positionsSnap = await db.collection('positions').where('electionId', '==', electionId).get();
                const container = document.getElementById('voting-positions-container');
                container.innerHTML = '';
                
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    const posDiv = document.createElement('div');
                    posDiv.className = 'position-card';
                    posDiv.innerHTML = `
                        <h3>${pos.name}</h3>
                        ${pos.description ? `<p style="color:#7f8c8d;margin-bottom:12px;">${pos.description}</p>` : ''}
                        <div class="candidates-list">
                            ${pos.candidates ? pos.candidates.map(cand => `
                                <label class="candidate-option">
                                    <input type="radio" name="position_${pos.id}" value="${cand.id}">
                                    <div class="candidate-info">
                                        <div class="candidate-name">${cand.name}</div>
                                        ${cand.bio ? `<div class="candidate-bio">${cand.bio}</div>` : ''}
                                    </div>
                                </label>
                            `).join('') : '<p>No candidates</p>'}
                        </div>
                    `;
                    container.appendChild(posDiv);
                });
                
                const saved = localStorage.getItem(`votes_${electionId}`);
                if (saved) {
                    userVotes = JSON.parse(saved);
                    Object.entries(userVotes).forEach(([posId, candId]) => {
                        const radio = document.querySelector(`[name="position_${posId}"][value="${candId}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                
                checkAdminAccess();
            } catch (error) {
                alert('‚ö†Ô∏è Failed to load: ' + error.message);
            }
        }
        
        async function submitVote() {
            if (!currentElectionId) { alert('‚ö†Ô∏è No active election'); return; }
            const selections = {};
            document.querySelectorAll('.position-card').forEach(posCard => {
                const posId = posCard.querySelector('.candidate-option input')?.name?.replace('position_', '');
                const selected = posCard.querySelector('input[type="radio"]:checked');
                if (posId && selected) selections[posId] = selected.value;
            });
            if (Object.keys(selections).length === 0) { alert('‚ö†Ô∏è Please select at least one candidate'); return; }
            
            try {
                localStorage.setItem(`votes_${currentElectionId}`, JSON.stringify(selections));
                const batch = db.batch();
                for (const candId of Object.values(selections)) {
                    const candRef = db.collection('candidates').doc(candId);
                    batch.update(candRef, { votes: firebase.firestore.FieldValue.increment(1) });
                }
                await batch.commit();
                alert('‚úÖ Vote submitted!');
                showSection('loading');
                setTimeout(() => { alert('üìä Check results with admin'); }, 500);
            } catch (error) {
                alert('‚ö†Ô∏è Failed: ' + error.message);
            }
        }
        
        async function loadElectionConfigForEdit() {
            if (!currentElectionId) { showSection('voting-section'); return; }
            document.getElementById('positions-container').innerHTML = '';
            try {
                const positionsSnap = await db.collection('positions').where('electionId', '==', currentElectionId).get();
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    const candidates = (pos.candidates || []).map(c => ({ ...c, votes: c.votes || 0 }));
                    addPositionField({ id: pos.id, name: pos.name, description: pos.description, candidates: candidates });
                });
            } catch (error) {
                alert('‚ö†Ô∏è Failed to load config');
            }
        }
        
        function returnToVotingAfterEdit() {
            if (currentElectionId) loadVotingInterface();
            setTimeout(() => {
                if (votingStateBeforeEdit) {
                    Object.entries(votingStateBeforeEdit).forEach(([pos, candId]) => {
                        const radio = document.querySelector(`[name="position_${pos}"][value="${candId}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                votingStateBeforeEdit = null;
                isEditingFromVoting = false;
            }, 300);
            showSection('voting-section');
            checkAdminAccess();
        }
        
        function openResetModal() { document.getElementById('reset-modal').classList.add('active'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.remove('active'); document.getElementById('reset-password-input').value = ''; }
        
        async function confirmResetElection() {
            const password = document.getElementById('reset-password-input').value;
            if (!password) { alert('‚ö†Ô∏è Enter password'); return; }
            try {
                const configSnap = await db.collection('system').doc('config').get();
                if (password !== (configSnap.data()?.adminPassword || 'admin123')) { alert('‚ùå Incorrect password'); return; }
                const batch = db.batch();
                const candsSnap = await db.collection('candidates').where('electionId', '==', currentElectionId).get();
                candsSnap.forEach(doc => batch.delete(doc.ref));
                const posSnap = await db.collection('positions').where('electionId', '==', currentElectionId).get();
                posSnap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await db.collection('system').doc('config').update({ currentElectionId: null, electionStatus: 'setup' });
                alert('‚úÖ Reset successfully');
                closeResetModal();
                showSection('setup-section');
                clearSetupForm();
                currentElectionId = null;
                isAdmin = false;
                sessionStorage.removeItem('isAdmin');
            } catch (error) {
                alert('‚ö†Ô∏è Failed: ' + error.message);
            }
        }
        
        async function init() {
            showSection('loading');
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const config = configSnap.data();
                if (config?.currentElectionId && config?.electionStatus === 'active') {
                    currentElectionId = config.currentElectionId;
                    showSection('voting-section');
                    loadVotingInterface();
                } else {
                    showSection('setup-section');
                }
                checkAdminAccess();
            } catch (error) {
                document.getElementById('loading-status').textContent = '‚ö†Ô∏è Check Firebase config';
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>