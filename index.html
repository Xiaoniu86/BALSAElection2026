<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Election Voting System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .header { text-align: center; padding: 20px 0; border-bottom: 2px solid #4a90e2; margin-bottom: 20px; }
        .header h1 { color: #2c3e50; font-size: 1.8rem; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* Ë°®ÂçïÊ†∑Âºè */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #2c3e50; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 10px 14px; border: 2px solid #e0e6ed; border-radius: 8px; 
            font-size: 1rem; transition: border-color 0.2s; 
        }
        .form-group input:focus { border-color: #4a90e2; outline: none; }
        
        /* ÊåâÈíÆÊ†∑Âºè */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .btn-primary { background: #4a90e2; color: white; }
        .btn-primary:hover { background: #357abd; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-admin-edit { background: #9b59b6; color: white; }
        .btn-admin-edit:hover { background: #8e44ad; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
        
        /* ÂÄôÈÄâ‰∫∫Âç°Áâá */
        .position-card { border: 1px solid #e0e6ed; border-radius: 10px; padding: 16px; margin-bottom: 16px; background: #fafbfc; }
        .position-card h3 { color: #2c3e50; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .candidate-option { display: flex; align-items: center; padding: 10px; margin: 6px 0; background: white; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .candidate-option:hover { background: #f0f4f8; border: 1px solid #4a90e2; }
        .candidate-option input { margin-right: 12px; transform: scale(1.2); }
        .candidate-info { flex: 1; }
        .candidate-name { font-weight: 600; color: #2c3e50; }
        .candidate-bio { font-size: 0.9rem; color: #7f8c8d; margin-top: 4px; }
        
        /* ÁÆ°ÁêÜÂëòÂ∑•ÂÖ∑Ê†è */
        #voting-admin-tools { 
            display: none; margin: 15px 0; padding: 12px; 
            background: #f8f4ff; border: 1px solid #d4b8f0; border-radius: 8px; 
        }
        
        /* Ê®°ÊÄÅÊ°Ü */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; 
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%; 
            box-shadow: 0 4px 24px rgba(0,0,0,0.2); 
        }
        .modal-content h4 { margin-bottom: 16px; color: #2c3e50; }
        .modal-content input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e0e6ed; border-radius: 6px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }
        
        /* Áä∂ÊÄÅÊèêÁ§∫ */
        .alert { padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 0.95rem; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        
        /* Âä†ËΩΩÁä∂ÊÄÅ */
        #loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .spinner { 
            width: 40px; height: 40px; border: 4px solid #e0e6ed; border-top-color: #4a90e2; 
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ÂìçÂ∫îÂºè */
        @media (max-width: 600px) {
            .btn-group { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è NGO Election Voting System</h1>
            <p>Secure ‚Ä¢ Anonymous ‚Ä¢ Real-time Results</p>
        </div>

        <!-- üîß Setup Section -->
        <div id="setup-section" class="section card">
            <h2>üõ†Ô∏è Election Setup</h2>
            <div class="alert alert-warning">
                ‚ö†Ô∏è Existing candidates loaded from database. You can modify and re-save to reset votes.
            </div>
            <p style="margin: 12px 0;">Configure positions and candidates. Once saved, voting begins.</p>
            
            <div class="form-group">
                <label>üîê Setup Password <small>(Default: admin123)</small></label>
                <input type="password" id="setup-password" placeholder="Enter admin password">
            </div>
            
            <div id="positions-container">
                <!-- Positions will be dynamically added here -->
            </div>
            
            <button onclick="addPositionField()" class="btn btn-secondary" style="margin: 10px 0;">‚ûï Add New Position</button>
            
            <div class="btn-group">
                <button onclick="saveElectionConfig()" class="btn btn-primary">üöÄ Start / Restart Election</button>
                <button onclick="clearSetupForm()" class="btn btn-secondary">üîÑ Clear Form</button>
            </div>
        </div>

        <!-- üó≥Ô∏è Voting Section -->
        <div id="voting-section" class="section card">
            <h2>üó≥Ô∏è NGO Annual Election</h2>
            <p style="margin: 10px 0;">Select your candidate for each position. Results appear immediately after voting.</p>
            
            <div class="alert alert-info" style="font-size: 0.9rem;">
                üìã Election ID: <span id="election-id-display">-</span> | 
                Started: <span id="election-start-display">-</span>
            </div>
            
            <!-- üîê Admin Edit Button (Hidden by default) -->
            <div id="voting-admin-tools">
                <button onclick="openEditFromVoting()" class="btn btn-admin-edit">
                    ‚úèÔ∏è Edit Candidates/Positions (Admin)
                </button>
            </div>
            
            <div id="voting-positions-container">
                <!-- Voting options will be rendered here -->
            </div>
            
            <button onclick="submitVote()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                ‚úÖ Submit My Vote
            </button>
            
            <div class="alert alert-warning" style="margin-top: 16px; font-size: 0.9rem;">
                üîí Your vote is anonymous. Each position can only be voted once per election.
            </div>
        </div>

        <!-- üìä Results Section -->
        <div id="results-section" class="section card">
            <h2>üìä Live Results</h2>
            <div id="results-container">
                <!-- Results will be rendered here -->
            </div>
        </div>

        <!-- ‚öôÔ∏è Loading -->
        <div id="loading" class="section">
            <div class="spinner"></div>
            <p>Loading Election System...</p>
            <p id="loading-status" style="color: #7f8c8d; font-size: 0.9rem;">Connecting to database</p>
        </div>

        <!-- ‚ö†Ô∏è Reset Confirmation Modal -->
        <div id="reset-modal" class="modal">
            <div class="modal-content">
                <h4>‚ö†Ô∏è Reset Election?</h4>
                <p style="margin: 12px 0;">This will reset all votes and allow everyone to vote again.</p>
                <p style="color: #e74c3c; font-weight: 600; margin: 8px 0;">‚ö†Ô∏è This action CANNOT be undone!</p>
                <input type="password" id="reset-password-input" placeholder="Enter Admin Password to Confirm:">
                <div class="modal-buttons">
                    <button onclick="closeResetModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmResetElection()" class="btn btn-danger">‚úÖ Confirm Reset</button>
                </div>
            </div>
        </div>

        <!-- üîê Admin Auth Modal (for editing from voting page) -->
        <div id="admin-auth-modal" class="modal">
            <div class="modal-content">
                <h4>üîê Admin Verification</h4>
                <p style="margin: 12px 0;">Enter password to edit candidates/positions:</p>
                <input type="password" id="admin-password-input" placeholder="Admin password">
                <div class="modal-buttons">
                    <button onclick="closeAdminModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="verifyAdminAndEdit()" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üîß Firebase Config - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Global state
        let currentElectionId = null;
        let userVotes = {}; // { positionId: candidateId }
        let isAdmin = false;
        
        // ========================================
        // üîê ADMIN & AUTH FUNCTIONS
        // ========================================
        
        function checkAdminAccess() {
            const saved = sessionStorage.getItem('isAdmin');
            if (saved === 'true') {
                isAdmin = true;
                document.getElementById('voting-admin-tools').style.display = 'block';
            }
        }
        
        function openEditFromVoting() {
            if (isAdmin) {
                showSection('setup-section');
                loadElectionConfigForEdit();
            } else {
                document.getElementById('admin-auth-modal').classList.add('active');
            }
        }
        
        function closeAdminModal() {
            document.getElementById('admin-auth-modal').classList.remove('active');
            document.getElementById('admin-password-input').value = '';
        }
        
        async function verifyAdminAndEdit() {
            const password = document.getElementById('admin-password-input').value;
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                
                if (password === adminPwd) {
                    sessionStorage.setItem('isAdmin', 'true');
                    isAdmin = true;
                    closeAdminModal();
                    document.getElementById('voting-admin-tools').style.display = 'block';
                    showSection('setup-section');
                    loadElectionConfigForEdit();
                } else {
                    alert('‚ùå Incorrect password');
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('‚ö†Ô∏è Verification failed. Please try again.');
            }
        }
        
        // ========================================
        // üîÑ NAVIGATION & UI
        // ========================================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            // Hide loading when showing content
            if (sectionId !== 'loading') {
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        function addPositionField(positionData = null) {
            const container = document.getElementById('positions-container');
            const posId = positionData?.id || 'pos_' + Date.now();
            
            const div = document.createElement('div');
            div.className = 'position-field';
            div.dataset.positionId = posId;
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <strong>Position #${container.children.length + 1}</strong>
                    <button onclick="this.closest('.position-field').remove()" class="btn btn-danger" style="padding:6px 12px; font-size:0.9rem;">üóëÔ∏è Remove</button>
                </div>
                <div class="form-group">
                    <label>Position Name</label>
                    <input type="text" class="position-name" value="${positionData?.name || ''}" placeholder="e.g., President">
                </div>
                <div class="form-group">
                    <label>Position Description (optional)</label>
                    <textarea class="position-desc" rows="2" placeholder="Brief description...">${positionData?.description || ''}</textarea>
                </div>
                <div class="candidates-list" id="candidates-${posId}">
                    ${positionData?.candidates?.map((c, i) => `
                        <div class="candidate-field" style="background:#f8f9fa; padding:10px; margin:8px 0; border-radius:6px;">
                            <input type="text" class="candidate-name" value="${c.name}" placeholder="Candidate name" style="width:100%; margin-bottom:6px;">
                            <textarea class="candidate-bio" placeholder="Brief bio..." style="width:100%; font-size:0.9rem;">${c.bio || ''}</textarea>
                            <input type="hidden" class="candidate-id" value="${c.id}">
                            <input type="hidden" class="candidate-votes" value="${c.votes || 0}">
                            <button onclick="this.closest('.candidate-field').remove()" style="margin-top:6px; background:#e74c3c; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">Remove</button>
                        </div>
                    `).join('') || ''}
                </div>
                <button type="button" onclick="addCandidateField('${posId}')" class="btn btn-secondary" style="margin:8px 0; font-size:0.9rem;">‚ûï Add Candidate</button>
                <hr style="margin:20px 0; border:none; border-top:1px solid #eee;">
            `;
            container.appendChild(div);
        }
        
        function addCandidateField(positionId) {
            const container = document.getElementById(`candidates-${positionId}`);
            const div = document.createElement('div');
            div.className = 'candidate-field';
            div.style.cssText = 'background:#f8f9fa; padding:10px; margin:8px 0; border-radius:6px;';
            div.innerHTML = `
                <input type="text" class="candidate-name" placeholder="Candidate name" style="width:100%; margin-bottom:6px;">
                <textarea class="candidate-bio" placeholder="Brief bio..." style="width:100%; font-size:0.9rem;"></textarea>
                <input type="hidden" class="candidate-id" value="cand_${Date.now()}">
                <input type="hidden" class="candidate-votes" value="0">
                <button onclick="this.closest('.candidate-field').remove()" style="margin-top:6px; background:#e74c3c; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">Remove</button>
            `;
            container.appendChild(div);
        }
        
        function clearSetupForm() {
            if (confirm('Clear all form data?')) {
                document.getElementById('positions-container').innerHTML = '';
                document.getElementById('setup-password').value = '';
            }
        }
        
        // ========================================
        // üíæ FIRESTORE OPERATIONS - SAFE UPDATES
        // ========================================
        
        /**
         * üîë KEY FUNCTION: Update candidate metadata WITHOUT affecting votes
         */
        async function updateCandidateMetadata(candidateId, metadataUpdates) {
            const candidateRef = db.collection('candidates').doc(candidateId);
            
            // Define protected fields that should NEVER be overwritten during edit
            const PROTECTED_FIELDS = ['votes', 'voteHistory', 'createdAt', 'electionId'];
            
            // Build safe update object (exclude protected fields)
            const safeUpdates = {};
            for (let key in metadataUpdates) {
                if (!PROTECTED_FIELDS.includes(key)) {
                    safeUpdates[key] = metadataUpdates[key];
                }
            }
            safeUpdates.lastModified = new Date();
            
            // Perform update - votes field remains untouched
            await candidateRef.update(safeUpdates);
            console.log(`‚úÖ Updated candidate ${candidateId} metadata (votes preserved)`);
        }
        
        /**
         * Update position metadata safely
         */
        async function updatePositionMetadata(positionId, updates) {
            const positionRef = db.collection('positions').doc(positionId);
            const PROTECTED = ['totalVotes', 'voterCount', 'createdAt'];
            
            const safeUpdates = {};
            for (let k in updates) {
                if (!PROTECTED.includes(k)) safeUpdates[k] = updates[k];
            }
            safeUpdates.lastModified = new Date();
            
            await positionRef.update(safeUpdates);
        }
        
        /**
         * Save election configuration (initial setup or admin edit)
         */
        async function saveElectionConfig() {
            const password = document.getElementById('setup-password').value;
            if (!password) { alert('‚ö†Ô∏è Please enter admin password'); return; }
            
            try {
                // Verify admin
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                if (password !== adminPwd) { alert('‚ùå Incorrect password'); return; }
                
                // Collect positions & candidates from form
                const positions = [];
                document.querySelectorAll('.position-field').forEach(posEl => {
                    const posId = posEl.dataset.positionId || 'pos_' + Date.now() + Math.random().toString(36).substr(2, 5);
                    const candidates = [];
                    
                    posEl.querySelectorAll('.candidate-field').forEach(candEl => {
                        const name = candEl.querySelector('.candidate-name').value.trim();
                        if (!name) return;
                        
                        candidates.push({
                            id: candEl.querySelector('.candidate-id')?.value || 'cand_' + Date.now(),
                            name: name,
                            bio: candEl.querySelector('.candidate-bio').value.trim(),
                            // üîë CRITICAL: Preserve existing votes if candidate already exists
                            votes: parseInt(candEl.querySelector('.candidate-votes')?.value) || 0,
                            photo: '',
                            lastModified: new Date()
                        });
                    });
                    
                    if (candidates.length > 0) {
                        positions.push({
                            id: posId,
                            name: posEl.querySelector('.position-name').value.trim(),
                            description: posEl.querySelector('.position-desc').value.trim(),
                            candidates: candidates,
                            createdAt: new Date()
                        });
                    }
                });
                
                if (positions.length === 0) { alert('‚ö†Ô∏è Add at least one position with candidates'); return; }
                
                // Generate election ID
                const electionId = 'election_' + Date.now();
                currentElectionId = electionId;
                
                // Batch write to Firestore
                const batch = db.batch();
                
                // Save positions
                positions.forEach(pos => {
                    const posRef = db.collection('positions').doc(pos.id);
                    batch.set(posRef, {
                        id: pos.id,
                        name: pos.name,
                        description: pos.description,
                        electionId: electionId,
                        createdAt: pos.createdAt,
                        totalVotes: 0
                    });
                    
                    // Save candidates
                    pos.candidates.forEach(cand => {
                        const candRef = db.collection('candidates').doc(cand.id);
                        batch.set(candRef, {
                            ...cand,
                            positionId: pos.id,
                            electionId: electionId
                        });
                    });
                });
                
                // Update system config
                const configRef = db.collection('system').doc('config');
                batch.set(configRef, {
                    currentElectionId: electionId,
                    electionStatus: 'active',
                    startedAt: new Date(),
                    adminPassword: password // Update if changed
                }, { merge: true });
                
                await batch.commit();
                
                alert('‚úÖ Election configured successfully!');
                showSection('voting-section');
                loadVotingInterface();
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ö†Ô∏è Failed to save: ' + error.message);
            }
        }
        
        // ========================================
        // üó≥Ô∏è VOTING INTERFACE
        // ========================================
        
        async function loadVotingInterface() {
            try {
                // Get current election
                const configSnap = await db.collection('system').doc('config').get();
                const electionId = configSnap.data()?.currentElectionId;
                if (!electionId) { showSection('setup-section'); return; }
                
                currentElectionId = electionId;
                document.getElementById('election-id-display').textContent = electionId;
                
                // Load positions
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', electionId)
                    .get();
                
                const container = document.getElementById('voting-positions-container');
                container.innerHTML = '';
                
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    const posDiv = document.createElement('div');
                    posDiv.className = 'position-card';
                    posDiv.dataset.positionId = pos.id;
                    
                    posDiv.innerHTML = `
                        <h3>${pos.name}</h3>
                        ${pos.description ? `<p style="color:#7f8c8d; font-size:0.95rem; margin-bottom:12px;">${pos.description}</p>` : ''}
                        <div class="candidates-list">
                            ${pos.candidates ? pos.candidates.map(cand => `
                                <label class="candidate-option">
                                    <input type="radio" name="position_${pos.id}" value="${cand.id}" data-position="${pos.id}">
                                    <div class="candidate-info">
                                        <div class="candidate-name">${cand.name}</div>
                                        ${cand.bio ? `<div class="candidate-bio">${cand.bio}</div>` : ''}
                                    </div>
                                </label>
                            `).join('') : '<p style="color:#999;">No candidates</p>'}
                        </div>
                    `;
                    container.appendChild(posDiv);
                });
                
                // Restore user selections if any
                const saved = localStorage.getItem(`votes_${electionId}`);
                if (saved) {
                    userVotes = JSON.parse(saved);
                    Object.entries(userVotes).forEach(([posId, candId]) => {
                        const radio = document.querySelector(`[name="position_${posId}"][value="${candId}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                
                // Listen for real-time candidate updates (for admin edits)
                positionsSnap.forEach(posDoc => {
                    db.collection('candidates')
                        .where('electionId', '==', electionId)
                        .where('positionId', '==', posDoc.data().id)
                        .onSnapshot(snapshot => {
                            // Update display names/bios without affecting vote state
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'modified') {
                                    const cand = change.doc.data();
                                    const nameEl = document.querySelector(`[value="${cand.id}"] .candidate-name`);
                                    const bioEl = document.querySelector(`[value="${cand.id}"] .candidate-bio`);
                                    if (nameEl) nameEl.textContent = cand.name;
                                    if (bioEl) bioEl.textContent = cand.bio || '';
                                }
                            });
                        });
                });
                
                checkAdminAccess();
                
            } catch (error) {
                console.error('Load voting error:', error);
                alert('‚ö†Ô∏è Failed to load voting interface');
            }
        }
        
        async function submitVote() {
            if (!currentElectionId) { alert('‚ö†Ô∏è No active election'); return; }
            
            // Collect selections
            const selections = {};
            let hasSelection = false;
            
            document.querySelectorAll('.position-card').forEach(posCard => {
                const posId = posCard.dataset.positionId;
                const selected = posCard.querySelector(`[name="position_${posId}"]:checked`);
                if (selected) {
                    selections[posId] = selected.value;
                    hasSelection = true;
                }
            });
            
            if (!hasSelection) { alert('‚ö†Ô∏è Please select at least one candidate'); return; }
            
            try {
                // Save to localStorage for recovery
                localStorage.setItem(`votes_${currentElectionId}`, JSON.stringify(selections));
                
                // Submit to Firestore (simplified - add your vote counting logic)
                const batch = db.batch();
                for (const [posId, candId] of Object.entries(selections)) {
                    const candRef = db.collection('candidates').doc(candId);
                    batch.update(candRef, {
                        votes: firebase.firestore.FieldValue.increment(1)
                    });
                }
                await batch.commit();
                
                alert('‚úÖ Vote submitted successfully!');
                showSection('results-section');
                loadResults();
                
            } catch (error) {
                console.error('Vote error:', error);
                alert('‚ö†Ô∏è Failed to submit vote: ' + error.message);
            }
        }
        
        // ========================================
        // üìä RESULTS & ADMIN FUNCTIONS
        // ========================================
        
        async function loadResults() {
            if (!currentElectionId) return;
            
            const container = document.getElementById('results-container');
            container.innerHTML = '<p style="text-align:center; padding:20px;">Loading results...</p>';
            
            try {
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', currentElectionId)
                    .get();
                
                let html = '';
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    html += `<div class="position-card"><h3>${pos.name}</h3>`;
                    
                    // Get candidates sorted by votes
                    const candsSnap = await db.collection('candidates')
                        .where('electionId', '==', currentElectionId)
                        .where('positionId', '==', pos.id)
                        .orderBy('votes', 'desc')
                        .get();
                    
                    candsSnap.forEach((candDoc, index) => {
                        const cand = candDoc.data();
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìç';
                        html += `
                            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                                <span>${medal} ${cand.name}</span>
                                <strong>${cand.votes || 0} votes</strong>
                            </div>
                        `;
                    });
                    html += '</div>';
                });
                
                container.innerHTML = html || '<p>No results yet</p>';
                
            } catch (error) {
                console.error('Results error:', error);
                container.innerHTML = '<p style="color:#e74c3c;">Failed to load results</p>';
            }
        }
        
        // Load config for admin editing (preserves existing votes)
        async function loadElectionConfigForEdit() {
            if (!currentElectionId) {
                alert('‚ö†Ô∏è No active election to edit');
                showSection('voting-section');
                return;
            }
            
            document.getElementById('positions-container').innerHTML = '';
            
            try {
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', currentElectionId)
                    .get();
                
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    addPositionField({
                        id: pos.id,
                        name: pos.name,
                        description: pos.description,
                        candidates: pos.candidates || []
                    });
                });
                
            } catch (error) {
                console.error('Load config error:', error);
                alert('‚ö†Ô∏è Failed to load configuration');
            }
        }
        
        // Reset election (admin only)
        function openResetModal() {
            document.getElementById('reset-modal').classList.add('active');
        }
        
        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('active');
            document.getElementById('reset-password-input').value = '';
        }
        
        async function confirmResetElection() {
            const password = document.getElementById('reset-password-input').value;
            if (!password) { alert('‚ö†Ô∏è Enter admin password'); return; }
            
            try {
                const configSnap = await db.collection('system').doc('config').get();
                if (password !== (configSnap.data()?.adminPassword || 'admin123')) {
                    alert('‚ùå Incorrect password'); return;
                }
                
                // Delete all candidates and positions for current election
                const batch = db.batch();
                const electionId = currentElectionId;
                
                const candsSnap = await db.collection('candidates').where('electionId', '==', electionId).get();
                candsSnap.forEach(doc => batch.delete(doc.ref));
                
                const posSnap = await db.collection('positions').where('electionId', '==', electionId).get();
                posSnap.forEach(doc => batch.delete(doc.ref));
                
                await batch.commit();
                
                // Reset config
                await db.collection('system').doc('config').update({
                    currentElectionId: null,
                    electionStatus: 'setup'
                });
                
                alert('‚úÖ Election reset successfully');
                closeResetModal();
                showSection('setup-section');
                clearSetupForm();
                
            } catch (error) {
                console.error('Reset error:', error);
                alert('‚ö†Ô∏è Failed to reset: ' + error.message);
            }
        }
        
        // ========================================
        // üöÄ INITIALIZATION
        // ========================================
        
        async function init() {
            showSection('loading');
            
            try {
                // Check if system is configured
                const configSnap = await db.collection('system').doc('config').get();
                const config = configSnap.data();
                
                if (config?.currentElectionId && config?.electionStatus === 'active') {
                    currentElectionId = config.currentElectionId;
                    showSection('voting-section');
                    loadVotingInterface();
                } else {
                    showSection('setup-section');
                }
                
                checkAdminAccess();
                
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loading-status').textContent = '‚ö†Ô∏è Connection failed - check Firebase config';
            }
        }
        
        // Start when DOM ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>