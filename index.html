<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Election Voting System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .header { text-align: center; padding: 30px 0; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 1rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #e0e6ed; border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        /* Button Styles */
        .btn { padding: 14px 28px; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: all 0.3s; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-admin { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
        
        /* Position Card */
        .position-card { border: 2px solid #e0e6ed; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: #fafbfc; transition: all 0.3s; }
        .position-card:hover { border-color: #667eea; box-shadow: 0 4px 20px rgba(102,126,234,0.1); }
        .position-card h3 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e6ed; font-size: 1.3rem; }
        
        /* Candidate Option */
        .candidate-option { display: flex; align-items: center; padding: 15px; margin: 10px 0; background: white; border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .candidate-option:hover { background: #f8f9ff; border-color: #667eea; }
        .candidate-option input[type="radio"] { margin-right: 15px; transform: scale(1.3); accent-color: #667eea; }
        .candidate-info { flex: 1; }
        .candidate-name { font-weight: 600; color: #2c3e50; font-size: 1.1rem; }
        .candidate-bio { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; line-height: 1.5; }
        
        /* Admin Panel in Voting Section */
        #voting-admin-panel { display: none; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%); border-radius: 10px; border: 2px solid #d4b8f0; }
        #voting-admin-panel.active { display: block; }
        #voting-admin-panel .admin-badge { display: inline-block; background: #9b59b6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-right: 10px; }
        
        /* Position Field (Setup) */
        .position-field { background: #f8f9fa; border: 2px solid #e0e6ed; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .position-field-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .candidates-list { margin-top: 15px; }
        .candidate-field { background: white; border: 1px solid #e0e6ed; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .candidate-field input, .candidate-field textarea { width: 100%; margin-bottom: 10px; }
        
        /* Alert Boxes */
        .alert { padding: 15px 20px; border-radius: 10px; margin: 15px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        .alert-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        .alert-info { background: #d1ecf1; border: 2px solid #bee5eb; color: #0c5460; }
        .alert-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .alert-danger { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.active { display: flex; animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; padding: 30px; border-radius: 16px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-content h4 { margin-bottom: 20px; color: #2c3e50; font-size: 1.4rem; }
        .modal-content input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 1rem; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        /* Loading */
        #loading { text-align: center; padding: 60px 20px; background: white; border-radius: 16px; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e0e6ed; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Results */
        .result-bar { height: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; margin: 10px 0; transition: width 0.5s ease; }
        .result-item { padding: 15px; border-bottom: 1px solid #e0e6ed; }
        .result-item:last-child { border-bottom: none; }
        
        /* Election Info Bar */
        .election-info-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .election-info-bar span { font-size: 0.95rem; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .btn-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .election-info-bar { flex-direction: column; text-align: center; }
            .header h1 { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è NGO Election Voting System</h1>
            <p>Secure ‚Ä¢ Anonymous ‚Ä¢ Real-time Results</p>
        </div>

        <!-- üîß SETUP SECTION -->
        <div id="setup-section" class="section card">
            <h2 style="margin-bottom: 15px; color: #2c3e50;">üõ†Ô∏è Election Setup</h2>
            
            <div class="alert alert-warning">
                ‚ö†Ô∏è <strong>Note:</strong> Existing candidates loaded from database. You can modify and re-save.
            </div>
            
            <p style="margin: 15px 0; color: #7f8c8d;">Configure positions and candidates. Once saved, voting begins.</p>
            
            <div class="form-group">
                <label>üîê Setup Password <small style="color: #7f8c8d; font-weight: normal;">(Default: admin123)</small></label>
                <input type="password" id="setup-password" placeholder="Enter admin password">
            </div>
            
            <div id="positions-container">
                <!-- Positions will be dynamically added here -->
            </div>
            
            <button type="button" onclick="addPositionField()" class="btn btn-secondary" style="margin: 15px 0;">
                ‚ûï Add New Position
            </button>
            
            <div class="btn-group">
                <button type="button" onclick="saveElectionConfig()" class="btn btn-primary">
                    üöÄ Start / Restart Election
                </button>
                <button type="button" onclick="clearSetupForm()" class="btn btn-secondary">
                    üîÑ Clear Form
                </button>
                <button type="button" onclick="showSection('voting-section')" class="btn btn-success">
                    ‚Üê Back to Voting
                </button>
            </div>
        </div>

        <!-- üó≥Ô∏è VOTING SECTION -->
        <div id="voting-section" class="section card">
            <h2 style="margin-bottom: 15px; color: #2c3e50;">üó≥Ô∏è NGO Annual Election</h2>
            <p style="margin: 10px 0; color: #7f8c8d;">Select your candidate for each position. Results appear immediately after voting.</p>
            
            <!-- Election Info Bar -->
            <div class="election-info-bar">
                <span>üìã Election ID: <strong id="election-id-display">-</strong></span>
                <span>üïê Started: <strong id="election-start-display">-</strong></span>
            </div>
            
            <!-- üîß ADMIN EDIT PANEL - NEW FEATURE -->
            <div id="voting-admin-panel">
                <span class="admin-badge">üë§ Admin Mode</span>
                <button type="button" onclick="openEditFromVoting()" class="btn btn-admin" style="padding: 10px 20px; font-size: 0.95rem;">
                    ‚úèÔ∏è Edit Candidates/Positions
                </button>
                <span id="admin-status" style="margin-left: 15px; color: #7f8c8d; font-size: 0.9rem;"></span>
            </div>
            
            <div id="voting-positions-container">
                <!-- Voting options will be rendered here -->
            </div>
            
            <button type="button" onclick="submitVote()" class="btn btn-primary" style="width: 100%; margin-top: 25px; font-size: 1.1rem;">
                ‚úÖ Submit My Vote
            </button>
            
            <div class="alert alert-info" style="margin-top: 20px;">
                üîí Your vote is anonymous. Each position can only be voted once per election.
            </div>
            
            <!-- Admin Only Section -->
            <div id="admin-only-section" style="display: none; margin-top: 25px; padding-top: 20px; border-top: 2px dashed #e0e6ed;">
                <h4 style="color: #9b59b6; margin-bottom: 15px;">‚ö†Ô∏è Admin Only</h4>
                <div class="btn-group">
                    <button type="button" onclick="openResetModal()" class="btn btn-danger">
                        üîÑ Reset & Edit Candidates
                    </button>
                    <button type="button" onclick="showSection('results-section'); loadResults();" class="btn btn-warning">
                        üìä View Results
                    </button>
                </div>
            </div>
        </div>

        <!-- üìä RESULTS SECTION -->
        <div id="results-section" class="section card">
            <h2 style="margin-bottom: 15px; color: #2c3e50;">üìä Live Results</h2>
            <div class="alert alert-info" style="margin-bottom: 20px;">
                üîÑ Results update in real-time as votes are cast
            </div>
            <div id="results-container">
                <!-- Results will be rendered here -->
            </div>
            <div class="btn-group" style="margin-top: 25px;">
                <button type="button" onclick="showSection('voting-section')" class="btn btn-secondary">
                    ‚Üê Back to Voting
                </button>
                <button type="button" onclick="loadResults()" class="btn btn-primary">
                    üîÑ Refresh Results
                </button>
            </div>
        </div>

        <!-- ‚öôÔ∏è LOADING SECTION -->
        <div id="loading" class="section">
            <div class="spinner"></div>
            <h3 style="color: #2c3e50; margin-bottom: 10px;">Loading Election System...</h3>
            <p id="loading-status" style="color: #7f8c8d;">Connecting to database</p>
        </div>

        <!-- ‚ö†Ô∏è RESET CONFIRMATION MODAL -->
        <div id="reset-modal" class="modal">
            <div class="modal-content">
                <h4>‚ö†Ô∏è Reset Election?</h4>
                <p style="margin: 15px 0; color: #7f8c8d;">This will reset all votes and allow everyone to vote again.</p>
                <div class="alert alert-danger" style="margin: 15px 0;">
                    ‚ö†Ô∏è <strong>This action CANNOT be undone!</strong>
                </div>
                <input type="password" id="reset-password-input" placeholder="Enter Admin Password to Confirm:">
                <div class="modal-buttons">
                    <button type="button" onclick="closeResetModal()" class="btn btn-secondary">Cancel</button>
                    <button type="button" onclick="confirmResetElection()" class="btn btn-danger">‚úÖ Confirm Reset</button>
                </div>
            </div>
        </div>

        <!-- üîê ADMIN AUTH MODAL (for editing from voting page) -->
        <div id="admin-auth-modal" class="modal">
            <div class="modal-content">
                <h4>üîê Admin Verification</h4>
                <p style="margin: 15px 0; color: #7f8c8d;">Enter password to edit candidates/positions:</p>
                <input type="password" id="admin-password-input" placeholder="Admin password">
                <div class="modal-buttons">
                    <button type="button" onclick="closeAdminModal()" class="btn btn-secondary">Cancel</button>
                    <button type="button" onclick="verifyAdminAndEdit()" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // üîß FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ========================================
        // üåç GLOBAL STATE
        // ========================================
        let currentElectionId = null;
        let userVotes = {};
        let isAdmin = false;
        let isEditingFromVoting = false;
        let votingStateBeforeEdit = null;
        let existingCandidatesData = {}; // Store existing candidate data for safe updates
        
        // ========================================
        // üîê ADMIN & AUTH FUNCTIONS
        // ========================================
        
        function checkAdminAccess() {
            const saved = sessionStorage.getItem('isAdmin');
            if (saved === 'true') {
                isAdmin = true;
                document.getElementById('voting-admin-panel').classList.add('active');
                document.getElementById('admin-only-section').style.display = 'block';
                document.getElementById('admin-status').textContent = '‚úì Verified';
            }
        }
        
        function openEditFromVoting() {
            if (isAdmin) {
                // Save current voting state before switching
                votingStateBeforeEdit = {};
                document.querySelectorAll('#voting-section input[type="radio"]:checked').forEach(radio => {
                    const posName = radio.name.replace('position_', '');
                    votingStateBeforeEdit[posName] = radio.value;
                });
                
                isEditingFromVoting = true;
                showSection('setup-section');
                loadElectionConfigForEdit();
            } else {
                document.getElementById('admin-auth-modal').classList.add('active');
            }
        }
        
        function closeAdminModal() {
            document.getElementById('admin-auth-modal').classList.remove('active');
            document.getElementById('admin-password-input').value = '';
        }
        
        async function verifyAdminAndEdit() {
            const password = document.getElementById('admin-password-input').value;
            if (!password) { alert('‚ö†Ô∏è Please enter password'); return; }
            
            try {
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                
                if (password === adminPwd) {
                    sessionStorage.setItem('isAdmin', 'true');
                    isAdmin = true;
                    closeAdminModal();
                    document.getElementById('voting-admin-panel').classList.add('active');
                    document.getElementById('admin-only-section').style.display = 'block';
                    document.getElementById('admin-status').textContent = '‚úì Verified';
                    
                    // Save current voting state
                    votingStateBeforeEdit = {};
                    document.querySelectorAll('#voting-section input[type="radio"]:checked').forEach(radio => {
                        const posName = radio.name.replace('position_', '');
                        votingStateBeforeEdit[posName] = radio.value;
                    });
                    
                    isEditingFromVoting = true;
                    showSection('setup-section');
                    loadElectionConfigForEdit();
                } else {
                    alert('‚ùå Incorrect password');
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('‚ö†Ô∏è Verification failed. Please try again.');
            }
        }
        
        // ========================================
        // üîÑ NAVIGATION & UI FUNCTIONS
        // ========================================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId !== 'loading') {
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        function addPositionField(positionData = null) {
            const container = document.getElementById('positions-container');
            const posId = positionData?.id || 'pos_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const positionNumber = container.children.length + 1;
            
            const div = document.createElement('div');
            div.className = 'position-field';
            div.dataset.positionId = posId;
            div.innerHTML = `
                <div class="position-field-header">
                    <strong style="color: #667eea; font-size: 1.1rem;">Position #${positionNumber}</strong>
                    <button type="button" onclick="this.closest('.position-field').remove()" class="btn btn-danger" style="padding: 8px 16px; font-size: 0.9rem;">üóëÔ∏è Remove</button>
                </div>
                <div class="form-group">
                    <label>Position Name</label>
                    <input type="text" class="position-name" value="${positionData?.name || ''}" placeholder="e.g., President, Secretary, Treasurer">
                </div>
                <div class="form-group">
                    <label>Position Description (optional)</label>
                    <textarea class="position-desc" rows="2" placeholder="Brief description of this position...">${positionData?.description || ''}</textarea>
                </div>
                <div class="candidates-list" id="candidates-${posId}">
                    ${positionData?.candidates?.map((c, i) => `
                        <div class="candidate-field" data-candidate-id="${c.id}">
                            <input type="text" class="candidate-name" value="${c.name || ''}" placeholder="Candidate name" style="margin-bottom: 10px;">
                            <textarea class="candidate-bio" rows="2" placeholder="Brief bio or manifesto..." style="margin-bottom: 10px;">${c.bio || ''}</textarea>
                            <input type="hidden" class="candidate-id" value="${c.id}">
                            <input type="hidden" class="candidate-votes" value="${c.votes || 0}">
                            <input type="hidden" class="candidate-positionId" value="${c.positionId || posId}">
                            <input type="hidden" class="candidate-electionId" value="${c.electionId || ''}">
                            <button type="button" onclick="this.closest('.candidate-field').remove()" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Remove Candidate</button>
                        </div>
                    `).join('') || '<p style="color: #7f8c8d; font-style: italic;">No candidates added yet. Click "Add Candidate" below.</p>'}
                </div>
                <button type="button" onclick="addCandidateField('${posId}')" class="btn btn-secondary" style="margin: 15px 0; font-size: 0.95rem;">‚ûï Add Candidate to This Position</button>
                <hr style="margin: 25px 0; border: none; border-top: 2px dashed #e0e6ed;">
            `;
            container.appendChild(div);
        }
        
        function addCandidateField(positionId) {
            const container = document.getElementById(`candidates-${positionId}`);
            const div = document.createElement('div');
            div.className = 'candidate-field';
            div.dataset.candidateId = 'cand_' + Date.now() + Math.random().toString(36).substr(2, 5);
            div.innerHTML = `
                <input type="text" class="candidate-name" placeholder="Candidate name" style="margin-bottom: 10px;">
                <textarea class="candidate-bio" rows="2" placeholder="Brief bio or manifesto..." style="margin-bottom: 10px;"></textarea>
                <input type="hidden" class="candidate-id" value="${div.dataset.candidateId}">
                <input type="hidden" class="candidate-votes" value="0">
                <input type="hidden" class="candidate-positionId" value="${positionId}">
                <input type="hidden" class="candidate-electionId" value="">
                <button type="button" onclick="this.closest('.candidate-field').remove()" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Remove Candidate</button>
            `;
            
            // Remove "no candidates" message if present
            const noCandMsg = container.querySelector('p');
            if (noCandMsg) noCandMsg.remove();
            
            container.appendChild(div);
        }
        
        function clearSetupForm() {
            if (confirm('Clear all form data? This will not affect saved data in database.')) {
                document.getElementById('positions-container').innerHTML = '';
                document.getElementById('setup-password').value = '';
                existingCandidatesData = {};
            }
        }
        
        // ========================================
        // üíæ FIRESTORE OPERATIONS - SAFE UPDATES
        // ========================================
        
        /**
         * üîë KEY FUNCTION: Update candidate metadata WITHOUT affecting votes
         * This ensures historical vote records remain intact
         */
        async function safeUpdateCandidate(candidateId, metadataUpdates) {
            const candidateRef = db.collection('candidates').doc(candidateId);
            
            // Define protected fields that should NEVER be overwritten during edit
            const PROTECTED_FIELDS = ['votes', 'voteHistory', 'createdAt', 'electionId', 'positionId'];
            
            // Build safe update object (exclude protected fields)
            const safeUpdates = {};
            for (let key in metadataUpdates) {
                if (!PROTECTED_FIELDS.includes(key)) {
                    safeUpdates[key] = metadataUpdates[key];
                }
            }
            safeUpdates.lastModified = new Date();
            
            // Perform update - votes field remains untouched
            await candidateRef.update(safeUpdates);
            console.log(`‚úÖ Updated candidate ${candidateId} metadata (votes preserved)`);
        }
        
        /**
         * Update position metadata safely
         */
        async function safeUpdatePosition(positionId, updates) {
            const positionRef = db.collection('positions').doc(positionId);
            const PROTECTED = ['totalVotes', 'voterCount', 'createdAt', 'electionId'];
            
            const safeUpdates = {};
            for (let k in updates) {
                if (!PROTECTED.includes(k)) safeUpdates[k] = updates[k];
            }
            safeUpdates.lastModified = new Date();
            
            await positionRef.update(safeUpdates);
        }
        
        /**
         * Save election configuration (initial setup or admin edit)
         */
        async function saveElectionConfig() {
            const password = document.getElementById('setup-password').value;
            if (!password) { 
                alert('‚ö†Ô∏è Please enter admin password'); 
                return; 
            }
            
            try {
                // Verify admin
                const configSnap = await db.collection('system').doc('config').get();
                const adminPwd = configSnap.data()?.adminPassword || 'admin123';
                if (password !== adminPwd) { 
                    alert('‚ùå Incorrect password'); 
                    return; 
                }
                
                // Collect positions & candidates from form
                const positions = [];
                const updatesOnly = isEditingFromVoting; // Flag to determine if we're editing existing
                
                document.querySelectorAll('.position-field').forEach(posEl => {
                    const posId = posEl.dataset.positionId;
                    const candidates = [];
                    
                    posEl.querySelectorAll('.candidate-field').forEach(candEl => {
                        const name = candEl.querySelector('.candidate-name').value.trim();
                        if (!name) return;
                        
                        const existingVotes = parseInt(candEl.querySelector('.candidate-votes')?.value) || 0;
                        const existingCandId = candEl.querySelector('.candidate-id')?.value;
                        const existingElectionId = candEl.querySelector('.candidate-electionId')?.value;
                        
                        candidates.push({
                            id: existingCandId || 'cand_' + Date.now(),
                            name: name,
                            bio: candEl.querySelector('.candidate-bio').value.trim(),
                            // üîë CRITICAL: Preserve existing votes if candidate already exists
                            votes: existingVotes,
                            positionId: posId,
                            electionId: existingElectionId || '',
                            photo: '',
                            lastModified: new Date()
                        });
                    });
                    
                    if (candidates.length > 0) {
                        positions.push({
                            id: posId,
                            name: posEl.querySelector('.position-name').value.trim(),
                            description: posEl.querySelector('.position-desc').value.trim(),
                            candidates: candidates,
                            createdAt: new Date()
                        });
                    }
                });
                
                if (positions.length === 0) { 
                    alert('‚ö†Ô∏è Add at least one position with candidates'); 
                    return; 
                }
                
                // Generate election ID (new or keep existing)
                const electionId = currentElectionId || 'election_' + Date.now();
                currentElectionId = electionId;
                
                if (updatesOnly) {
                    // üîë EDIT MODE: Only update metadata, preserve votes
                    await updateExistingElection(positions, electionId);
                } else {
                    // NEW ELECTION MODE: Full setup
                    await createNewElection(positions, electionId, password);
                }
                
                alert('‚úÖ Election configured successfully!');
                
                // Return to voting section after save
                if (isEditingFromVoting) {
                    returnToVotingAfterEdit();
                } else {
                    showSection('voting-section');
                    loadVotingInterface();
                }
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ö†Ô∏è Failed to save: ' + error.message);
            }
        }
        
        /**
         * Update existing election (edit mode) - preserves all votes
         */
        async function updateExistingElection(positions, electionId) {
            const batch = db.batch();
            
            positions.forEach(pos => {
                // Update position metadata only
                const posRef = db.collection('positions').doc(pos.id);
                batch.update(posRef, {
                    name: pos.name,
                    description: pos.description,
                    lastModified: new Date()
                });
                
                // Update candidates metadata only (votes preserved)
                pos.candidates.forEach(cand => {
                    const candRef = db.collection('candidates').doc(cand.id);
                    // Only update name, bio - NOT votes
                    batch.update(candRef, {
                        name: cand.name,
                        bio: cand.bio,
                        lastModified: new Date()
                    });
                });
            });
            
            await batch.commit();
            console.log('‚úÖ Existing election updated (votes preserved)');
        }
        
        /**
         * Create new election (fresh setup)
         */
        async function createNewElection(positions, electionId, password) {
            const batch = db.batch();
            
            // Save positions
            positions.forEach(pos => {
                const posRef = db.collection('positions').doc(pos.id);
                batch.set(posRef, {
                    id: pos.id,
                    name: pos.name,
                    description: pos.description,
                    electionId: electionId,
                    createdAt: pos.createdAt,
                    totalVotes: 0
                });
                
                // Save candidates
                pos.candidates.forEach(cand => {
                    const candRef = db.collection('candidates').doc(cand.id);
                    batch.set(candRef, {
                        ...cand,
                        electionId: electionId
                    });
                });
            });
            
            // Update system config
            const configRef = db.collection('system').doc('config');
            batch.set(configRef, {
                currentElectionId: electionId,
                electionStatus: 'active',
                startedAt: new Date(),
                adminPassword: password
            }, { merge: true });
            
            await batch.commit();
            console.log('‚úÖ New election created');
        }
        
        // ========================================
        // üó≥Ô∏è VOTING INTERFACE FUNCTIONS
        // ========================================
        
        async function loadVotingInterface() {
            try {
                // Get current election
                const configSnap = await db.collection('system').doc('config').get();
                const electionId = configSnap.data()?.currentElectionId;
                
                if (!electionId) { 
                    showSection('setup-section'); 
                    return; 
                }
                
                currentElectionId = electionId;
                document.getElementById('election-id-display').textContent = electionId;
                
                const startedAt = configSnap.data()?.startedAt;
                if (startedAt) {
                    document.getElementById('election-start-display').textContent = 
                        new Date(startedAt.seconds * 1000).toLocaleDateString();
                }
                
                // Load positions
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', electionId)
                    .get();
                
                const container = document.getElementById('voting-positions-container');
                container.innerHTML = '';
                
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    const posDiv = document.createElement('div');
                    posDiv.className = 'position-card';
                    posDiv.dataset.positionId = pos.id;
                    
                    posDiv.innerHTML = `
                        <h3>${pos.name}</h3>
                        ${pos.description ? `<p style="color:#7f8c8d; font-size:0.95rem; margin-bottom:15px;">${pos.description}</p>` : ''}
                        <div class="candidates-list">
                            ${pos.candidates ? pos.candidates.map(cand => `
                                <label class="candidate-option">
                                    <input type="radio" name="position_${pos.id}" value="${cand.id}" data-position="${pos.id}">
                                    <div class="candidate-info">
                                        <div class="candidate-name">${cand.name}</div>
                                        ${cand.bio ? `<div class="candidate-bio">${cand.bio}</div>` : ''}
                                    </div>
                                </label>
                            `).join('') : '<p style="color:#999; font-style:italic;">No candidates for this position</p>'}
                        </div>
                    `;
                    container.appendChild(posDiv);
                });
                
                // Restore user selections if any (from localStorage)
                const saved = localStorage.getItem(`votes_${electionId}`);
                if (saved) {
                    userVotes = JSON.parse(saved);
                    Object.entries(userVotes).forEach(([posId, candId]) => {
                        const radio = document.querySelector(`[name="position_${posId}"][value="${candId}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                
                // Set up real-time listeners for candidate updates (admin edits)
                positionsSnap.forEach(posDoc => {
                    db.collection('candidates')
                        .where('electionId', '==', electionId)
                        .where('positionId', '==', posDoc.data().id)
                        .onSnapshot(snapshot => {
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'modified') {
                                    const cand = change.doc.data();
                                    const nameEl = document.querySelector(`[value="${cand.id}"] .candidate-name`);
                                    const bioEl = document.querySelector(`[value="${cand.id}"] .candidate-bio`);
                                    if (nameEl) nameEl.textContent = cand.name;
                                    if (bioEl) bioEl.textContent = cand.bio || '';
                                }
                            });
                        });
                });
                
                checkAdminAccess();
                
            } catch (error) {
                console.error('Load voting error:', error);
                alert('‚ö†Ô∏è Failed to load voting interface: ' + error.message);
            }
        }
        
        async function submitVote() {
            if (!currentElectionId) { 
                alert('‚ö†Ô∏è No active election'); 
                return; 
            }
            
            // Collect selections
            const selections = {};
            let hasSelection = false;
            
            document.querySelectorAll('.position-card').forEach(posCard => {
                const posId = posCard.dataset.positionId;
                const selected = posCard.querySelector(`[name="position_${posId}"]:checked`);
                if (selected) {
                    selections[posId] = selected.value;
                    hasSelection = true;
                }
            });
            
            if (!hasSelection) { 
                alert('‚ö†Ô∏è Please select at least one candidate'); 
                return; 
            }
            
            try {
                // Save to localStorage for recovery
                localStorage.setItem(`votes_${currentElectionId}`, JSON.stringify(selections));
                
                // Submit to Firestore
                const batch = db.batch();
                for (const [posId, candId] of Object.entries(selections)) {
                    const candRef = db.collection('candidates').doc(candId);
                    batch.update(candRef, {
                        votes: firebase.firestore.FieldValue.increment(1)
                    });
                }
                await batch.commit();
                
                alert('‚úÖ Vote submitted successfully!');
                showSection('results-section');
                loadResults();
                
            } catch (error) {
                console.error('Vote error:', error);
                alert('‚ö†Ô∏è Failed to submit vote: ' + error.message);
            }
        }
        
        // ========================================
        // üìä RESULTS FUNCTIONS
        // ========================================
        
        async function loadResults() {
            if (!currentElectionId) return;
            
            const container = document.getElementById('results-container');
            container.innerHTML = '<p style="text-align:center; padding:30px; color:#7f8c8d;">Loading results...</p>';
            
            try {
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', currentElectionId)
                    .get();
                
                let html = '';
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    html += `<div class="position-card"><h3>${pos.name}</h3>`;
                    
                    // Get candidates sorted by votes
                    const candsSnap = await db.collection('candidates')
                        .where('electionId', '==', currentElectionId)
                        .where('positionId', '==', pos.id)
                        .orderBy('votes', 'desc')
                        .get();
                    
                    let totalVotes = 0;
                    const candidates = [];
                    candsSnap.forEach(candDoc => {
                        const cand = candDoc.data();
                        candidates.push(cand);
                        totalVotes += (cand.votes || 0);
                    });
                    
                    candidates.forEach((cand, index) => {
                        const votes = cand.votes || 0;
                        const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìç';
                        
                        html += `
                            <div class="result-item">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                    <span style="font-weight:600;">${medal} ${cand.name}</span>
                                    <strong>${votes} votes (${percentage}%)</strong>
                                </div>
                                <div class="result-bar" style="width: ${percentage}%;"></div>
                            </div>
                        `;
                    });
                    html += '</div>';
                });
                
                container.innerHTML = html || '<p style="text-align:center; padding:30px; color:#7f8c8d;">No results yet</p>';
                
            } catch (error) {
                console.error('Results error:', error);
                container.innerHTML = '<p style="color:#e74c3c; text-align:center; padding:30px;">Failed to load results</p>';
            }
        }
        
        // ========================================
        // üîß EDIT FROM VOTING FUNCTIONS
        // ========================================
        
        /**
         * Load existing election config for editing
         */
        async function loadElectionConfigForEdit() {
            if (!currentElectionId) {
                alert('‚ö†Ô∏è No active election to edit');
                showSection('voting-section');
                return;
            }
            
            document.getElementById('positions-container').innerHTML = '';
            document.getElementById('setup-password').value = '';
            
            try {
                const positionsSnap = await db.collection('positions')
                    .where('electionId', '==', currentElectionId)
                    .get();
                
                positionsSnap.forEach(posDoc => {
                    const pos = posDoc.data();
                    
                    // Load candidates with their current vote counts
                    const candidatesWithVotes = [];
                    pos.candidates?.forEach(cand => {
                        candidatesWithVotes.push({
                            ...cand,
                            votes: cand.votes || 0 // Preserve vote count
                        });
                    });
                    
                    addPositionField({
                        id: pos.id,
                        name: pos.name,
                        description: pos.description,
                        candidates: candidatesWithVotes
                    });
                });
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info';
                alertDiv.innerHTML = 'üìù <strong>Edit Mode:</strong> You can modify candidate names and bios. Vote counts will be preserved.';
                document.getElementById('positions-container').prepend(alertDiv);
                
            } catch (error) {
                console.error('Load config error:', error);
                alert('‚ö†Ô∏è Failed to load configuration: ' + error.message);
            }
        }
        
        /**
         * Return to voting interface after edit
         */
        function returnToVotingAfterEdit() {
            // Refresh voting interface
            if (currentElectionId) {
                loadVotingInterface();
            }
            
            // Restore user's previous selections
            setTimeout(() => {
                if (votingStateBeforeEdit) {
                    Object.entries(votingStateBeforeEdit).forEach(([pos, candId]) => {
                        const radio = document.querySelector(`#voting-section [name="position_${pos}"][value="${candId}"]`);
                        if (radio) radio.checked = true;
                    });
                }
                votingStateBeforeEdit = null;
                isEditingFromVoting = false;
            }, 300);
            
            // Switch back to voting section
            showSection('voting-section');
            checkAdminAccess();
        }
        
        // ========================================
        // üîÑ RESET ELECTION FUNCTIONS
        // ========================================
        
        function openResetModal() {
            document.getElementById('reset-modal').classList.add('active');
        }
        
        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('active');
            document.getElementById('reset-password-input').value = '';
        }
        
        async function confirmResetElection() {
            const password = document.getElementById('reset-password-input').value;
            if (!password) { 
                alert('‚ö†Ô∏è Enter admin password'); 
                return; 
            }
            
            try {
                const configSnap = await db.collection('system').doc('config').get();
                if (password !== (configSnap.data()?.adminPassword || 'admin123')) {
                    alert('‚ùå Incorrect password'); 
                    return; 
                }
                
                // Delete all candidates and positions for current election
                const batch = db.batch();
                const electionId = currentElectionId;
                
                const candsSnap = await db.collection('candidates')
                    .where('electionId', '==', electionId)
                    .get();
                candsSnap.forEach(doc => batch.delete(doc.ref));
                
                const posSnap = await db.collection('positions')
                    .where('electionId', '==', electionId)
                    .get();
                posSnap.forEach(doc => batch.delete(doc.ref));
                
                await batch.commit();
                
                // Reset config
                await db.collection('system').doc('config').update({
                    currentElectionId: null,
                    electionStatus: 'setup'
                });
                
                alert('‚úÖ Election reset successfully');
                closeResetModal();
                showSection('setup-section');
                clearSetupForm();
                currentElectionId = null;
                isAdmin = false;
                sessionStorage.removeItem('isAdmin');
                
            } catch (error) {
                console.error('Reset error:', error);
                alert('‚ö†Ô∏è Failed to reset: ' + error.message);
            }
        }
        
        // ========================================
        // üöÄ INITIALIZATION
        // ========================================
        
        async function init() {
            showSection('loading');
            
            try {
                // Check if system is configured
                const configSnap = await db.collection('system').doc('config').get();
                const config = configSnap.data();
                
                if (config?.currentElectionId && config?.electionStatus === 'active') {
                    currentElectionId = config.currentElectionId;
                    showSection('voting-section');
                    loadVotingInterface();
                } else {
                    showSection('setup-section');
                }
                
                checkAdminAccess();
                
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('loading-status').textContent = '‚ö†Ô∏è Connection failed - check Firebase config';
            }
        }
        
        // Start when DOM ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>