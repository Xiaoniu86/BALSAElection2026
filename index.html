<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO Election Voting System</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --pitch-bg: #e8f8f0;
            --pitch-border: #27ae60;
            --nominee-bg: #f9f9f9;
            --nominee-border: #bdc3c7;
            --text-main: #333;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #17a2b8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: var(--text-main); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1, h2 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .hidden { display: none !important; }
        
        /* Setup Page */
        .setup-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; margin: 40px auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary); }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52,152,219,0.2); }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        button:hover { background: #34495e; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button.secondary { background: #95a5a6; }
        button.secondary:hover { background: #7f8c8d; }
        button.danger { background: var(--danger); }
        button.danger:hover { background: #c0392b; }
        button.info { background: var(--info); }
        button.info:hover { background: #138496; }
        button.warning { background: var(--warning); }
        button.warning:hover { background: #d68910; }
        
        .position-setup-item { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .position-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px; }
        .position-title-input { flex: 1; min-width: 200px; font-weight: 600; font-size: 1.1rem; padding: 8px 12px; }
        .remove-position-btn { background: var(--danger); padding: 6px 14px; font-size: 0.9rem; border-radius: 4px; }
        
        .candidate-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .candidate-row input { flex: 2; min-width: 150px; }
        .candidate-row select { flex: 1; min-width: 120px; }
        .remove-btn { background: var(--danger); width: auto; padding: 8px 14px; border-radius: 4px; }
        
        .add-position-btn { width: 100%; margin: 20px 0 10px; background: var(--accent); padding: 12px; font-size: 1rem; }
        .add-position-btn:hover { background: #2980b9; }

        /* Voting Page */
        .positions-grid { display: grid; grid-template-columns: 1fr; gap: 25px; margin-top: 30px; }
        @media (min-width: 768px) { .positions-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .positions-grid { grid-template-columns: repeat(3, 1fr); } }

        .position-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: box-shadow 0.2s; }
        .position-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
        .position-title { font-size: 1.3rem; font-weight: 700; color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 12px; margin-bottom: 15px; text-align: center; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        
        .candidate-item { display: grid; grid-template-columns: 1fr auto; gap: 15px; padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; border: 2px solid transparent; align-items: center; transition: all 0.2s; }
        .candidate-item:hover { transform: translateX(3px); }
        .type-pitch { background-color: var(--pitch-bg); border-color: var(--pitch-border); }
        .type-pitch .candidate-name::after { content: "üé§ Pitching"; font-size: 0.75rem; background: var(--pitch-border); color: white; padding: 3px 8px; border-radius: 4px; margin-left: 12px; vertical-align: middle; font-weight: 500; }
        .type-nominee { background-color: var(--nominee-bg); border-color: var(--nominee-border); color: #555; }
        .type-nominee .candidate-name::after { content: "üìå Nominee"; font-size: 0.75rem; background: var(--nominee-border); color: white; padding: 3px 8px; border-radius: 4px; margin-left: 12px; vertical-align: middle; font-weight: 500; }
        .candidate-name { font-size: 1rem; font-weight: 500; word-break: break-word; }
        
        .vote-btn { background-color: var(--primary); color: white; border: none; padding: 8px 22px; border-radius: 25px; cursor: pointer; font-size: 0.95rem; white-space: nowrap; min-width: 80px; transition: all 0.2s; font-weight: 500; }
        .vote-btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; transform: none !important; }
        .vote-btn:hover:not(:disabled) { background-color: #34495e; transform: scale(1.05); }
        .vote-btn.voted { background-color: var(--success); }
        .vote-btn.voted:hover { background-color: #219653; }

        /* Results */
        .results-area { margin-top: 15px; padding-top: 15px; border-top: 2px dashed #eee; }
        .result-row { display: grid; grid-template-columns: 2fr 3fr 1fr; align-items: center; margin-bottom: 10px; font-size: 0.95rem; gap: 12px; }
        .res-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; color: var(--text-main); }
        .res-bar-bg { background: #ecf0f1; height: 14px; border-radius: 7px; overflow: hidden; }
        .res-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #2ecc71); width: 0%; transition: width 0.6s ease; border-radius: 7px; }
        .res-count { text-align: right; font-weight: 700; color: var(--primary); font-size: 1rem; }
        .locked-message { text-align: center; color: #7f8c8d; font-style: italic; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 10px; font-size: 0.95rem; }

        /* Admin Bar */
        .admin-bar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .admin-bar h3 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        .admin-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .admin-buttons button { background: white; color: var(--primary); font-weight: 600; padding: 8px 16px; border-radius: 6px; transition: all 0.2s; }
        .admin-buttons button:hover { background: #f8f9fa; transform: translateY(-1px); }
        .btn-edit { color: var(--info); }
        .btn-reset { color: var(--danger); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 30px; border-radius: 14px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 { color: var(--danger); margin-top: 0; font-size: 1.3rem; }
        .modal-content p { color: #555; margin: 12px 0; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 25px; }
        .modal-buttons button { flex: 1; padding: 10px; font-weight: 600; }

        /* Loading */
        .loading-view { text-align: center; margin-top: 80px; }
        .spinner { border: 4px solid #ecf0f1; border-top: 4px solid var(--accent); border-radius: 50%; width: 55px; height: 55px; animation: spin 1s linear infinite; margin: 0 auto 25px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--success); color: white; padding: 14px 24px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); transform: translateY(100px); opacity: 0; transition: all 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 1001; font-weight: 500; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* Info Boxes */
        .setup-info { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .setup-edit-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .election-info { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <!-- SETUP PAGE -->
    <div id="setup-view" class="hidden">
        <div class="setup-box">
            <h2>üõ†Ô∏è Election Setup</h2>
            <div id="setup-edit-info" class="setup-edit-info hidden">‚úèÔ∏è <strong>Edit Mode:</strong> Modify candidates. <strong>Votes will be preserved.</strong></div>
            <div id="setup-info" class="setup-info hidden">‚ö†Ô∏è Existing candidates loaded. Re-saving will <strong>reset all votes</strong>.</div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Configure positions and candidates.</p>
            <div class="form-group">
                <label>üîê Admin Password (Default: admin123)</label>
                <input type="password" id="setup-password" placeholder="Enter admin password">
            </div>
            <div id="positions-form-container"></div>
            <button class="add-position-btn" onclick="addPositionField()">‚ûï Add New Position</button>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="save-btn" onclick="saveElectionConfig()" style="flex: 2;">üöÄ Start Election</button>
                <button class="secondary" onclick="resetAllFields()" style="flex: 1;">üîÑ Clear Form</button>
            </div>
        </div>
    </div>

    <!-- VOTING PAGE -->
    <div id="voting-view" class="hidden">
        <header style="text-align: center; margin-bottom: 20px;">
            <h1>üó≥Ô∏è NGO Annual Election</h1>
            <p style="color: #666;">Select your candidate for each position. Results appear immediately.</p>
        </header>
        <div id="election-info" class="election-info hidden">
            üìã Election ID: <strong id="election-id-display">-</strong> | 
            Started: <strong id="election-date-display">-</strong>
        </div>
        <div class="admin-bar hidden" id="admin-bar">
            <h3>üëë Admin Panel</h3>
            <div class="admin-buttons">
                <button class="btn-edit" onclick="editCandidates()">‚úèÔ∏è Edit Candidates</button>
                <button class="btn-reset" onclick="showResetModal()">üóëÔ∏è Reset Election</button>
            </div>
        </div>
        <div id="positions-grid" class="positions-grid"></div>
        <div style="text-align: center; margin-top: 30px; color: #999;">
            <p>üîí Anonymous voting. One vote per position per device.</p>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loading-view" class="loading-view">
        <div class="spinner"></div>
        <h2>Loading Election System...</h2>
        <p style="color: #666;">Connecting to database</p>
    </div>
</div>

<!-- Reset Modal -->
<div id="reset-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>‚ö†Ô∏è Reset Election?</h3>
        <p><strong>This will DELETE ALL votes and candidates.</strong></p>
        <p style="color: var(--danger); font-size: 0.9rem;">‚ö†Ô∏è This action CANNOT be undone!</p>
        <div class="form-group">
            <label>Enter Admin Password to Confirm:</label>
            <input type="password" id="reset-password" placeholder="Admin password" onkeypress="if(event.key==='Enter')confirmReset()">
        </div>
        <div class="modal-buttons">
            <button class="secondary" onclick="hideResetModal()">Cancel</button>
            <button class="danger" onclick="confirmReset()">üóëÔ∏è Reset Everything</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, getDocs, updateDoc, increment, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAXUttZVQ3u3N-1UJW7uF9h6j6TW0HGcKQ",
        authDomain: "balsa-election.firebaseapp.com",
        projectId: "balsa-election",
        storageBucket: "balsa-election.firebasestorage.app",
        messagingSenderId: "201567605989",
        appId: "1:201567605989:web:94cbfd4c0ced3289ef700c",
        measurementId: "G-EC7QSC9BMV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Constants
    const DEFAULT_POSITIONS = ["President", "Co-President", "VP-EO", "VP-IO", "DoHR", "DoM", "DoO", "DoPD", "DoF", "DoDEI"];
    const ADMIN_PASSWORD = "admin123";

    // State
    let localVotes = {};
    let currentElectionId = null;
    let existingCandidates = [];
    let isEditMode = false;

    // DOM Elements
    const setupView = document.getElementById('setup-view');
    const votingView = document.getElementById('voting-view');
    const loadingView = document.getElementById('loading-view');
    const positionsFormContainer = document.getElementById('positions-form-container');
    const positionsGrid = document.getElementById('positions-grid');
    const resetModal = document.getElementById('reset-modal');
    const toast = document.getElementById('toast');
    const setupInfo = document.getElementById('setup-info');
    const setupEditInfo = document.getElementById('setup-edit-info');
    const electionInfo = document.getElementById('election-info');
    const adminBar = document.getElementById('admin-bar');
    const saveBtn = document.getElementById('save-btn');
    const electionIdDisplay = document.getElementById('election-id-display');
    const electionDateDisplay = document.getElementById('election-date-display');

    // Toast Notification
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => toast.className = 'toast', 3000);
    }

    // Generate Election ID
    function generateElectionId() {
        return 'ELECT-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- INITIALIZATION ---
    async function init() {
        try {
            const configDoc = await getDoc(doc(db, "system", "config"));
            if (configDoc.exists()) {
                const data = configDoc.data();
                showVotingPage(data);
            } else {
                showSetupPage(false);
            }
        } catch (e) {
            console.error("Init error:", e);
            showToast("Connection error", 'error');
            loadingView.classList.add('hidden');
        }
    }

    // --- SETUP PAGE ---
    async function showSetupPage(editMode = false) {
        loadingView.classList.add('hidden');
        setupView.classList.remove('hidden');
        votingView.classList.add('hidden');
        adminBar.classList.add('hidden');
        
        isEditMode = editMode;
        positionsFormContainer.innerHTML = '';
        existingCandidates = [];
        
        if (editMode) {
            setupEditInfo.classList.remove('hidden');
            setupInfo.classList.add('hidden');
            saveBtn.textContent = "üíæ Save Changes (Keep Votes)";
            saveBtn.className = 'info';
        } else {
            setupEditInfo.classList.add('hidden');
            setupInfo.classList.add('hidden');
            saveBtn.textContent = "üöÄ Start Election";
            saveBtn.className = '';
        }

        // Load existing candidates
        try {
            const snapshot = await getDocs(collection(db, "candidates"));
            if (!snapshot.empty) {
                snapshot.forEach(d => {
                    existingCandidates.push({ id: d.id, ...d.data() });
                });
                
                const byPos = {};
                existingCandidates.forEach(c => {
                    if (!byPos[c.position]) byPos[c.position] = [];
                    byPos[c.position].push(c);
                });
                
                Object.keys(byPos).forEach(pos => addPositionField(pos, byPos[pos]));
                
                if (!editMode) {
                    setupInfo.classList.remove('hidden');
                    showToast("üìù Existing candidates loaded");
                } else {
                    showToast("‚úèÔ∏è Edit Mode: Votes preserved", 'info');
                }
            } else {
                DEFAULT_POSITIONS.forEach(p => addPositionField(p));
            }
        } catch (e) {
            console.error("Load error:", e);
            DEFAULT_POSITIONS.forEach(p => addPositionField(p));
        }
    }

    // Add Position Field
    window.addPositionField = (name = '', candidates = []) => {
        const div = document.createElement('div');
        div.className = 'position-setup-item';
        div.innerHTML = `
            <div class="position-header">
                <input type="text" class="position-title-input" value="${name || `Position ${document.querySelectorAll('.position-setup-item').length + 1}`}" placeholder="Position Name">
                <button class="remove-position-btn" onclick="this.closest('.position-setup-item').remove()">üóëÔ∏è Remove</button>
            </div>
            <div class="candidates-container"></div>
            <button class="secondary" onclick="addCandidateRow(this)" style="width:auto;font-size:0.85rem">‚ûï Candidate</button>
        `;
        positionsFormContainer.appendChild(div);
        
        const container = div.querySelector('.candidates-container');
        if (candidates.length > 0) {
            candidates.forEach(c => {
                const row = document.createElement('div');
                row.className = 'candidate-row';
                row.innerHTML = `
                    <input type="text" class="cand-name" value="${escapeHtml(c.name || '')}" placeholder="Name">
                    <select class="cand-type">
                        <option value="pitch" ${c.type === 'pitch' ? 'selected' : ''}>üé§ Pitching</option>
                        <option value="nominee" ${c.type === 'nominee' ? 'selected' : ''}>üìå Nominee</option>
                    </select>
                    <button class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
                `;
                container.appendChild(row);
            });
        } else {
            addCandidateRow(div.querySelector('.secondary'));
        }
    };

    // Add Candidate Row
    window.addCandidateRow = (btn) => {
        const container = btn.parentElement.querySelector('.candidates-container');
        const row = document.createElement('div');
        row.className = 'candidate-row';
        row.innerHTML = `
            <input type="text" class="cand-name" placeholder="Candidate Name">
            <select class="cand-type">
                <option value="pitch">üé§ Pitching</option>
                <option value="nominee">üìå Nominee</option>
            </select>
            <button class="remove-btn" onclick="this.parentElement.remove()">‚úï</button>
        `;
        container.appendChild(row);
    };

    // Remove Position
    window.removePositionField = (btn) => {
        const count = document.querySelectorAll('.position-setup-item').length;
        if (count <= 1) { showToast("Need at least 1 position!", 'error'); return; }
        btn.closest('.position-setup-item').remove();
    };

    // Reset Form
    window.resetAllFields = () => {
        if (confirm("Clear all fields?")) {
            positionsFormContainer.innerHTML = '';
            DEFAULT_POSITIONS.forEach(p => addPositionField(p));
            setupInfo.classList.add('hidden');
            setupEditInfo.classList.add('hidden');
            showToast("Form cleared!");
        }
    };

    // --- SAVE CONFIG ---
    window.saveElectionConfig = async () => {
        const pwd = document.getElementById('setup-password').value;
        if (pwd !== ADMIN_PASSWORD) { showToast("Wrong password", 'error'); return; }

        const items = document.querySelectorAll('.position-setup-item');
        if (items.length === 0) { showToast("Add at least 1 position", 'error'); return; }

        const candidates = [];
        let error = false;
        
        items.forEach(item => {
            const pos = item.querySelector('.position-title-input').value.trim();
            if (!pos) { error = true; return; }
            item.querySelectorAll('.candidate-row').forEach(row => {
                const name = row.querySelector('.cand-name').value.trim();
                const type = row.querySelector('.cand-type').value;
                if (name) candidates.push({ position: pos, name, type, votes: 0 });
            });
        });

        if (error) { showToast("Fill all position names", 'error'); return; }
        if (candidates.length === 0) { showToast("Add at least 1 candidate", 'error'); return; }

        try {
            showToast("Saving...");

            // Delete old candidates
            if (existingCandidates.length > 0) {
                const batch = writeBatch(db);
                existingCandidates.forEach(c => batch.delete(doc(db, "candidates", c.id)));
                await batch.commit();
            }

            if (isEditMode) {
                // ‚úÖ EDIT MODE: Keep electionId, preserve votes
                await updateDoc(doc(db, "system", "config"), { lastEdited: new Date() });
                showToast("üíæ Changes saved! Votes preserved.", 'info');
                // üî• KEY: Do NOT clear localStorage in edit mode
            } else {
                // ‚úÖ NEW ELECTION: New electionId, clear votes
                const newId = generateElectionId();
                await setDoc(doc(db, "system", "config"), { status: "active", electionId: newId, createdAt: new Date() });
                // üî• KEY: Clear localStorage only for new election
                localStorage.removeItem('ngo_votes');
                localStorage.setItem('ngo_election_id', newId);
                currentElectionId = newId;
                localVotes = {};
                showToast("‚úÖ New election started!", 'success');
            }

            // Add new candidates
            await Promise.all(candidates.map(c => addDoc(collection(db, "candidates"), c)));

            isEditMode = false;
            setTimeout(() => location.reload(), 1200);

        } catch (e) {
            console.error("Save error:", e);
            showToast("Error: " + e.message, 'error');
        }
    };

    // --- VOTING PAGE ---
    function showVotingPage(config) {
        loadingView.classList.add('hidden');
        votingView.classList.remove('hidden');
        setupView.classList.add('hidden');
        adminBar.classList.remove('hidden');
        
        const serverElectionId = config.electionId || 'UNKNOWN';
        electionIdDisplay.textContent = serverElectionId;
        
        if (config.createdAt) {
            const date = config.createdAt.toDate ? config.createdAt.toDate() : new Date(config.createdAt);
            electionDateDisplay.textContent = date.toLocaleString();
        }
        electionInfo.classList.remove('hidden');
        
        // üî• KEY LOGIC: Only clear votes if electionId changed
        const storedId = localStorage.getItem('ngo_election_id');
        
        if (storedId && storedId !== serverElectionId) {
            // New election - clear old votes
            localStorage.removeItem('ngo_votes');
            localStorage.setItem('ngo_election_id', serverElectionId);
            localVotes = {};
            console.log("New election detected, cleared votes");
        } else if (!storedId) {
            // First time - initialize
            localStorage.setItem('ngo_election_id', serverElectionId);
            localVotes = JSON.parse(localStorage.getItem('ngo_votes') || '{}');
        } else {
            // Same election (including edit mode) - KEEP votes üî•
            localVotes = JSON.parse(localStorage.getItem('ngo_votes') || '{}');
        }
        
        currentElectionId = serverElectionId;
        loadCandidates();
    }

    // Load Candidates (Realtime)
    function loadCandidates() {
        onSnapshot(collection(db, "candidates"), (snapshot) => {
            const byPos = {};
            snapshot.forEach(d => {
                const data = d.data();
                if (!byPos[data.position]) byPos[data.position] = [];
                byPos[data.position].push({ id: d.id, ...data });
            });
            renderGrid(byPos);
        });
    }

    // Render Grid
    function renderGrid(byPos) {
        positionsGrid.innerHTML = '';
        const positions = Object.keys(byPos).sort();

        if (positions.length === 0) {
            positionsGrid.innerHTML = '<p style="text-align:center;color:#666;">No candidates</p>';
            return;
        }

        positions.forEach(pos => {
            const card = document.createElement('div');
            card.className = 'position-card';
            
            const voted = localVotes[pos] === true;
            let html = `<div class="position-title">${escapeHtml(pos)}</div>`;
            
            let totalVotes = 0;
            byPos[pos].forEach(c => totalVotes += (c.votes || 0));

            byPos[pos].forEach(c => {
                const cls = c.type === 'pitch' ? 'type-pitch' : 'type-nominee';
                const safeName = escapeHtml(c.name);
                const safePos = encodeURIComponent(pos);
                const safeId = encodeURIComponent(c.id);
                
                html += `
                    <div class="candidate-item ${cls}">
                        <span class="candidate-name">${safeName}</span>
                        <button class="vote-btn ${voted ? 'voted' : ''}" 
                                onclick="window.castVote('${safePos}','${safeId}')" 
                                ${voted ? 'disabled' : ''}>
                            ${voted ? '‚úì Voted' : 'Vote'}
                        </button>
                    </div>
                `;

                const pct = totalVotes ? Math.round((c.votes / totalVotes) * 100) : 0;
                html += `
                    <div class="results-area">
                        <div class="result-row">
                            <div class="res-name">${safeName}</div>
                            <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                            <div class="res-count">${c.votes || 0}</div>
                        </div>
                    </div>
                `;
            });

            if (!voted) {
                html += '<div class="locked-message">üîí Vote to see results</div>';
            }

            card.innerHTML = html;
            positionsGrid.appendChild(card);
        });
    }

    // --- CAST VOTE ---
    window.castVote = async (pos, id) => {
        const position = decodeURIComponent(pos);
        const candidateId = decodeURIComponent(id);
        
        if (localVotes[position]) { showToast("Already voted", 'error'); return; }
        if (!confirm(`Vote for ${position}?`)) return;

        try {
            await updateDoc(doc(db, "candidates", candidateId), { votes: increment(1) });
            
            localVotes[position] = true;
            localStorage.setItem('ngo_votes', JSON.stringify(localVotes));
            
            showToast("‚úÖ Voted!");
            loadCandidates();
        } catch (e) {
            console.error("Vote error:", e);
            showToast("Failed: " + e.message, 'error');
        }
    };

    // --- ADMIN: EDIT (preserve votes) ---
    window.editCandidates = () => {
        isEditMode = true;
        showSetupPage(true);
    };

    // --- ADMIN: RESET (clear all) ---
    window.showResetModal = () => {
        resetModal.classList.remove('hidden');
        document.getElementById('reset-password').value = '';
    };
    window.hideResetModal = () => resetModal.classList.add('hidden');

    window.confirmReset = async () => {
        const pwd = document.getElementById('reset-password').value;
        if (pwd !== ADMIN_PASSWORD) { showToast("Wrong password", 'error'); return; }

        try {
            showToast("Resetting...");
            const snapshot = await getDocs(collection(db, "candidates"));
            if (!snapshot.empty) {
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
            await deleteDoc(doc(db, "system", "config"));
            localStorage.removeItem('ngo_votes');
            localStorage.removeItem('ngo_election_id');
            showToast("‚úÖ Reset complete!");
            hideResetModal();
            setTimeout(() => location.reload(), 1200);
        } catch (e) {
            console.error("Reset error:", e);
            showToast("Error: " + e.message, 'error');
        }
    };

    // Start App
    init();
</script>
</body>
</html>